<% layout('layout') %>
<h1>Müşteri Listesi</h1>
<div class="loading">Veriler yükleniyor...</div>
<table id="musterilerTable" style="display:none;">
    <thead>
    <tr>
        <th data-key="ad">Ad</th>
        <th data-key="sonkontrol">Son Giriş</th>
        <th data-key="borc">Borç</th>
        <th data-key="numara">İletişim</th>
    </tr>
    </thead>
    <tbody id="musterilerTableBody">
    <!-- Veriler burada listelenecek -->
    </tbody>
</table>

<script>
    let musteriData = [];
    async function fetchMusteriData() {
        try {
            const response = await fetch('/api/musteriler');
            if (!response.ok) throw new Error("Veri çekme hatası");
            return await response.json();
        } catch (error) {
            console.error("Hata:", error);
            return [];
        }
    }
    function renderMusteriler(data) {
        const tableBody = document.getElementById('musterilerTableBody');
        tableBody.innerHTML = "";
        data.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
        <td>${item.ad}</td>
        <td>${item.sonkontrol}</td>
        <td>${item.borc}</td>
        <td>${item.numara || 'Yok'}</td>
      `;
            tableBody.appendChild(row);
        });
    }
    function sortMusteriler(key) {
        musteriData.sort((a, b) => {
            if(a[key] < b[key]) return -1;
            if(a[key] > b[key]) return 1;
            return 0;
        });
        renderMusteriler(musteriData);
    }
    document.querySelectorAll("th[data-key]").forEach(header => {
        header.addEventListener('click', () => {
            const key = header.getAttribute('data-key');
            sortMusteriler(key);
        });
    });
    window.addEventListener('DOMContentLoaded', async () => {
        musteriData = await fetchMusteriData();
        document.querySelector('.loading').style.display = "none";
        document.getElementById('musterilerTable').style.display = "table";
        renderMusteriler(musteriData);
    });
</script>
